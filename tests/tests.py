import unittest
from rtg.core.dispatcher import Dispatcher


class MyTestCase(unittest.TestCase):

    def setUp(self) -> None:

        temp = {
            # Save of 1
            1: {
                'subnets': {
                    'A': "10.0.0.0/24",
                    'B': "192.168.0.0/24",
                    'C': "192.168.1.0/24",
                    'D': "10.0.1.0/24"
                },
                'routers': {
                    1: None,
                    2: None,
                    3: None,
                    4: True
                },
                'links': {
                    1: {
                        'B': "192.168.0.254",
                        'C': "192.168.1.254"
                    },
                    2: {
                        "A": "10.0.0.254",
                        "B": "192.168.0.253"
                    },
                    4: {'D': "10.0.1.254"},
                    3: {
                        "C": "192.168.1.253",
                        "D": "10.0.1.253"
                    }
                },
                'expected_hops': {
                    (0, 1): [1],
                    (0, 2): [1, 0],
                    (0, 3): [1, 0, 2],
                    (1, 0): [1],
                    (1, 2): [0],
                    (1, 3): [0, 2],
                    (2, 0): [0, 1],
                    (2, 1): [0],
                    (2, 3): [2],
                    (3, 0): [2, 0, 1],
                    (3, 1): [2, 0],
                    (3, 2): [2]

                },
                'expected_result': {
                    1: {
                        "192.168.0.0/24": "192.168.0.254",
                        "192.168.1.0/24": "192.168.1.254",
                        "10.0.0.0/24": "192.168.0.253",
                        "10.0.1.0/24": "192.168.1.253",
                        "0.0.0.0/0": "192.168.1.253"
                    },
                    2: {
                        "192.168.0.0/24": "192.168.0.253",
                        "10.0.0.0/24": "10.0.0.254",
                        "0.0.0.0/0": "192.168.0.254",
                        "192.168.1.0/24": "192.168.0.254",
                        "10.0.1.0/24": "192.168.0.254"
                    },
                    3: {
                        "192.168.1.0/24": "192.168.1.253",
                        "10.0.1.0/24": "10.0.1.253",
                        "0.0.0.0/0": "10.0.1.254",
                        "192.168.0.0/24": "192.168.1.254",
                        "10.0.0.0/24": "192.168.1.254"
                    },
                    4: {
                        "10.0.1.0/24": "10.0.1.254",
                        "0.0.0.0/0": "10.0.1.254",
                        "192.168.0.0/24": "10.0.1.253",
                        "192.168.1.0/24": "10.0.1.253",
                        "10.0.0.0/24": "10.0.1.253"
                    }
                }
            },
            2: {
                'subnets': {
                    'A': "192.168.0.0/24",
                    'B': "192.168.1.0/24",
                    'C': "10.0.0.0/24",
                    'D': "10.0.1.0/24"
                },
                'routers': {
                    1: True,
                    2: None,
                    4: None,
                    5: None
                },
                'links': {
                    1: ['A', 'B'],
                    2: ['B', 'C'],
                    4: ['A', 'D'],
                    5: ['C', 'D']
                }
            }
        }

        self.networks = {
            # Basic network configuration
            1: {
                'name': "Basic",
                'subnets': {
                    'A': "10.0.0.0/24",
                    'B': "192.168.0.0/24",
                    'C': "192.168.1.0/24",
                    'D': "10.0.1.0/24"
                },
                'routers': {
                    1: None,
                    2: None,
                    3: None,
                    4: True
                },
                'links': {
                    1: {
                        'B': None,
                        'C': None
                    },
                    2: {
                        "A": None,
                        "B": None
                    },
                    4: {'D': None},
                    3: {
                        "C": None,
                        "D": None
                    }
                },
                'instance': None,
                'expected_network': {
                    'subnets': {
                        0: {
                            'id': 0,
                            'name': 'A',
                            'connected_routers': [{'uid': 1, 'ip': '10.0.0.254'}],
                            'range': {'start': '10.0.0.0', 'end': '10.0.0.255'},
                            'mask': 24
                        },
                        1: {
                            'id': 1,
                            'name': 'B',
                            'connected_routers': [{'uid': 0, 'ip': '192.168.0.254'}, {'uid': 1, 'ip': '192.168.0.253'}],
                            'range': {'start': '192.168.0.0', 'end': '192.168.0.255'},
                            'mask': 24
                        },
                        2: {
                            'id': 2,
                            'name': 'C',
                            'connected_routers': [{'uid': 0, 'ip': '192.168.1.254'}, {'uid': 2, 'ip': '192.168.1.253'}],
                            'range': {'start': '192.168.1.0', 'end': '192.168.1.255'},
                            'mask': 24
                        },
                        3: {
                            'id': 3,
                            'name': 'D',
                            'connected_routers': [{'uid': 3, 'ip': '10.0.1.254'}, {'uid': 2, 'ip': '10.0.1.253'}],
                            'range': {'start': '10.0.1.0', 'end': '10.0.1.255'},
                            'mask': 24
                        }
                    },
                    'routers': {
                        0: {
                            'id': 0,
                            'name': '1',
                            'connected_subnets': [{'uid': 1, 'ip': '192.168.0.254'}, {'uid': 2, 'ip': '192.168.1.254'}],
                            'internet': False
                        },
                        1: {
                            'id': 1,
                            'name': '2',
                            'connected_subnets': [{'uid': 0, 'ip': '10.0.0.254'}, {'uid': 1, 'ip': '192.168.0.253'}],
                            'internet': False
                        },
                        2: {
                            'id': 2,
                            'name': '3',
                            'connected_subnets': [{'uid': 2, 'ip': '192.168.1.253'}, {'uid': 3, 'ip': '10.0.1.253'}],
                            'internet': False
                        },
                        3: {
                            'id': 3,
                            'name': '4',
                            'connected_subnets': [{'uid': 3, 'ip': '10.0.1.254'}],
                            'internet': True
                        }
                    }
                },
                'expected_hops': {
                    (0, 1): [1],
                    (0, 2): [1, 0],
                    (0, 3): [1, 0, 2],
                    (1, 0): [1],
                    (1, 2): [0],
                    (1, 3): [0, 2],
                    (2, 0): [0, 1],
                    (2, 1): [0],
                    (2, 3): [2],
                    (3, 0): [2, 0, 1],
                    (3, 1): [2, 0],
                    (3, 2): [2]

                },
                'expected_result': {
                    1: {
                        "192.168.0.0/24": "192.168.0.254",
                        "192.168.1.0/24": "192.168.1.254",
                        "10.0.0.0/24": "192.168.0.253",
                        "10.0.1.0/24": "192.168.1.253",
                        "0.0.0.0/0": "192.168.1.253"
                    },
                    2: {
                        "192.168.0.0/24": "192.168.0.253",
                        "10.0.0.0/24": "10.0.0.254",
                        "0.0.0.0/0": "192.168.0.254",
                        "192.168.1.0/24": "192.168.0.254",
                        "10.0.1.0/24": "192.168.0.254"
                    },
                    3: {
                        "192.168.1.0/24": "192.168.1.253",
                        "10.0.1.0/24": "10.0.1.253",
                        "0.0.0.0/0": "10.0.1.254",
                        "192.168.0.0/24": "192.168.1.254",
                        "10.0.0.0/24": "192.168.1.254"
                    },
                    4: {
                        "10.0.1.0/24": "10.0.1.254",
                        "0.0.0.0/0": "10.0.1.254",
                        "192.168.0.0/24": "10.0.1.253",
                        "192.168.1.0/24": "10.0.1.253",
                        "10.0.0.0/24": "10.0.1.253"
                    }
                }
            },
            # Now with personalised IPs to routers
            2: {
                'name': "Personalised IPs",
                'subnets': {
                    'A': "10.0.0.0/24",
                    'B': "192.168.0.0/24",
                    'C': "192.168.1.0/24",
                    'D': "10.0.1.0/24"
                },
                'routers': {
                    1: None,
                    2: None,
                    3: None,
                    4: True
                },
                'links': {
                    1: {
                        'B': "192.168.0.26",
                        'C': "192.168.1.250"
                    },
                    2: {
                        "A": "10.0.0.45",
                        "B": "192.168.0.253"
                    },
                    4: {'D': "10.0.1.254"},
                    3: {
                        "C": "192.168.1.253",
                        "D": "10.0.1.253"
                    }
                },
                'instance': None,
                'expected_network': {
                    'subnets': {
                        0: {
                            'id': 0,
                            'name': 'A',
                            'connected_routers': [{'uid': 1, 'ip': '10.0.0.45'}],
                            'range': {'start': '10.0.0.0', 'end': '10.0.0.255'},
                            'mask': 24
                        },
                        1: {
                            'id': 1,
                            'name': 'B',
                            'connected_routers': [{'uid': 0, 'ip': '192.168.0.26'}, {'uid': 1, 'ip': '192.168.0.253'}],
                            'range': {'start': '192.168.0.0', 'end': '192.168.0.255'},
                            'mask': 24
                        },
                        2: {
                            'id': 2,
                            'name': 'C',
                            'connected_routers': [{'uid': 0, 'ip': '192.168.1.250'}, {'uid': 2, 'ip': '192.168.1.253'}],
                            'range': {'start': '192.168.1.0', 'end': '192.168.1.255'},
                            'mask': 24
                        },
                        3: {
                            'id': 3,
                            'name': 'D',
                            'connected_routers': [{'uid': 3, 'ip': '10.0.1.254'}, {'uid': 2, 'ip': '10.0.1.253'}],
                            'range': {'start': '10.0.1.0', 'end': '10.0.1.255'},
                            'mask': 24
                        }
                    },
                    'routers': {
                        0: {
                            'id': 0,
                            'name': '1',
                            'connected_subnets': [{'uid': 1, 'ip': '192.168.0.26'}, {'uid': 2, 'ip': '192.168.1.250'}],
                            'internet': False
                        },
                        1: {
                            'id': 1,
                            'name': '2',
                            'connected_subnets': [{'uid': 0, 'ip': '10.0.0.45'}, {'uid': 1, 'ip': '192.168.0.253'}],
                            'internet': False
                        },
                        2: {
                            'id': 2,
                            'name': '3',
                            'connected_subnets': [{'uid': 2, 'ip': '192.168.1.253'}, {'uid': 3, 'ip': '10.0.1.253'}],
                            'internet': False
                        },
                        3: {
                            'id': 3,
                            'name': '4',
                            'connected_subnets': [{'uid': 3, 'ip': '10.0.1.254'}],
                            'internet': True
                        }
                    }
                },
                'expected_hops': {
                    (0, 1): [1],
                    (0, 2): [1, 0],
                    (0, 3): [1, 0, 2],
                    (1, 0): [1],
                    (1, 2): [0],
                    (1, 3): [0, 2],
                    (2, 0): [0, 1],
                    (2, 1): [0],
                    (2, 3): [2],
                    (3, 0): [2, 0, 1],
                    (3, 1): [2, 0],
                    (3, 2): [2]

                },
                'expected_result': {
                    1: {
                        "192.168.0.0/24": "192.168.0.26",
                        "192.168.1.0/24": "192.168.1.250",
                        "10.0.0.0/24": "192.168.0.253",
                        "10.0.1.0/24": "192.168.1.253",
                        "0.0.0.0/0": "192.168.1.253"
                    },
                    2: {
                        "192.168.0.0/24": "192.168.0.253",
                        "10.0.0.0/24": "10.0.0.45",
                        "0.0.0.0/0": "192.168.0.26",
                        "192.168.1.0/24": "192.168.0.26",
                        "10.0.1.0/24": "192.168.0.26"
                    },
                    3: {
                        "192.168.1.0/24": "192.168.1.253",
                        "10.0.1.0/24": "10.0.1.253",
                        "0.0.0.0/0": "10.0.1.254",
                        "192.168.0.0/24": "192.168.1.250",
                        "10.0.0.0/24": "192.168.1.250"
                    },
                    4: {
                        "10.0.1.0/24": "10.0.1.254",
                        "0.0.0.0/0": "10.0.1.254",
                        "192.168.0.0/24": "10.0.1.253",
                        "192.168.1.0/24": "10.0.1.253",
                        "10.0.0.0/24": "10.0.1.253"
                    }
                }
            }
        }

        for nid in self.networks:
            net = self.networks[nid]
            inst = Dispatcher()
            inst.execute(net['subnets'], net['routers'], net['links'])
            self.networks[nid]['instance'] = inst

    def test_1_network_check(self):
        print(f"Configuration [network]")

        for number in self.networks:
            n = self.networks[number]
            inst = n['instance']

            result = inst.network_raw_output()

            # testing hops
            self.assertEqual(n['expected_network'], result, f'{n["name"]} : Network')
            print(f'Passed : {n["name"]}')

    def test_2_hops(self):
        print(f"\n\nConfiguration [hops]")

        for number in self.networks:
            n = self.networks[number]
            inst = n['instance']

            hops = inst.hops

            # testing hops
            for matrix in n['expected_hops']:
                expected = n['expected_hops'][matrix]
                res = hops[matrix]

                self.assertEqual(expected, res, f'{n["name"]} : Ants : tuple {matrix}')

            print(f"Passed : {n['name']}")


if __name__ == '__main__':
    unittest.main()
